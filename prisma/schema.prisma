// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// Organizational role enum
enum UserRole {
  ADMIN
  PRECON_LEAD
  SCOPE_CAPTAIN
  PRECON_ANALYST
}

// User authentication model
model User {
  id                    String           @id @default(cuid())
  email                 String           @unique
  userName              String           @unique
  firstName             String?
  lastName              String?
  avatarUrl             String?
  passwordHash          String
  role                  UserRole         @default(PRECON_ANALYST)
  passwordResetRequired Boolean          @default(false)
  isActive              Boolean          @default(true)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  lastLoginAt           DateTime?
  sessions              Session[]
  userAssignments       UserAssignment[]
  captainBidPackages    BidPackage[]     @relation("BidPackageCaptain")

  @@index([email])
  @@index([userName])
  @@index([role])
}

// Session model for JWT tokens
model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// BuildingConnected Project model
model BuildingConnectedProject {
  id                String           @id @default(cuid())
  bcProjectId       String           @unique // BC's 24-char project ID
  accProjectId      String?          // Autodesk Construction Cloud UUID
  accDocsFolderId   String?          // ACC Docs folder ID

  // Basic info
  name              String
  projectNumber     String?
  description       String?          @db.Text
  status            String           @default("active") // active, bidding, awarded, closed, archived

  // Dates
  bidDueDate        DateTime?
  expectedStartDate DateTime?
  expectedEndDate   DateTime?

  // Location
  address           String?
  city              String?
  state             String?
  zipCode           String?
  country           String?

  // Project details
  projectSize       Float?
  projectSizeUnit   String?          // SF, square meters, etc.
  projectValue      Float?           // Estimated value in dollars
  marketSector      String?          // Commercial, Healthcare, Education, etc.
  typeOfWork        String?          // New Construction, Renovation, etc.
  architect         String?
  client            String?          // Owner/client name
  accountManager    String?
  owningOffice      String?
  feePercentage     Float?

  // Precon Lead (user with PRECON_LEAD or ADMIN role)
  preconLeadId      String?
  preconLeadEmail   String?
  preconLeadName    String?
  preconLeadAvatar  String?

  // Sync metadata
  lastSyncedAt      DateTime?
  syncStatus        String           @default("pending") // pending, syncing, synced, error
  syncError         String?          @db.Text

  // Relations
  diagrams          Diagram[]        // Project-level diagrams
  bidPackages       BidPackage[]
  userAssignments   UserAssignment[]
  extractionSessions ExtractionSession[]

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  deletedAt         DateTime?        // Soft delete timestamp

  @@index([bcProjectId])
  @@index([status])
  @@index([bidDueDate])
  @@index([preconLeadId])
}

// Bid Package model
model BidPackage {
  id                String                       @id @default(cuid())
  bcBidPackageId    String                       @unique // BC bid package ID
  bcProjectId       String
  project           BuildingConnectedProject     @relation(fields: [bcProjectId], references: [id], onDelete: Cascade)

  // Basic info
  name              String

  // Dates
  bidDueDate        DateTime?

  // Status tracking
  status            String                       @default("to do") // to do, assigned, in progress, in review, bidding, bidding leveling, completed
  progress          Int                          @default(0) // 0-100 percentage

  // Additional fields
  captainId         String?                      // Captain assigned to this bid package
  captain           User?                        @relation("BidPackageCaptain", fields: [captainId], references: [id], onDelete: SetNull)
  captainName       String?                      // Legacy field - kept for backward compatibility

  // Diagram references (stored as JSON array of diagram IDs from parent project)
  diagramIds        String?                      @db.Text // JSON array of diagram IDs

  // Workspace data (stored as JSON for flexible schema)
  workspaceData     String?                      @db.Text // JSON object with lineItems, chatMessages, etc.

  // Relations
  bidForms          BidForm[]
  userAssignments   UserAssignment[]

  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt

  @@index([bcProjectId])
  @@index([status])
}

// User assignment to projects/bid packages (organizational roles determine permissions)
model UserAssignment {
  id              String                      @id @default(cuid())
  userId          String
  user            User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userEmail       String
  userName        String
  // Note: role field removed - permissions now based on User.role (organizational role)

  // Assignment can be to either a project OR a bid package
  bcProjectId     String?
  project         BuildingConnectedProject?   @relation(fields: [bcProjectId], references: [id], onDelete: Cascade)
  bidPackageId    String?
  bidPackage      BidPackage?                 @relation(fields: [bidPackageId], references: [id], onDelete: Cascade)

  // Assignment metadata
  assignedAt      DateTime                    @default(now())
  assignedBy      String?                     // User ID of who made the assignment

  @@unique([userId, bcProjectId])
  @@unique([userId, bidPackageId])
  @@index([userId])
  @@index([bcProjectId])
  @@index([bidPackageId])
}

// Legacy Project model (kept for backward compatibility)
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  diagrams    Diagram[]
  bidForms    BidForm[]
}

// Updated Diagram model - belongs to BuildingConnectedProject (or legacy Project)
model Diagram {
  id            String                       @id @default(cuid())

  // New: Link to BuildingConnectedProject (primary relation)
  bcProjectId   String?
  bcProject     BuildingConnectedProject?    @relation(fields: [bcProjectId], references: [id], onDelete: Cascade)

  // Legacy: Keep Project relation for backward compatibility
  projectId     String?
  project       Project?                     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  fileName      String
  fileUrl       String
  fileType      String
  fileSize      Int
  fileHash      String?                      @unique // SHA-256 hash for duplicate detection
  uploadedAt    DateTime                     @default(now())
  uploadedBy    String?                      // User ID who uploaded

  // Optional categorization
  category      String?                      // e.g., 'Floor Plan', 'Elevation', 'Detail'
  description   String?                      @db.Text
  tags          String?                      @db.Text // JSON array of tags

  // Large document support
  pageCount           Int?                   // Total pages in document
  processedPages      Int                    @default(0) // Number of pages processed
  processingStatus    String                 @default("pending") // pending, processing, completed, failed
  processingError     String?                @db.Text

  bidForms      BidForm[]
  pages         DocumentPage[]               // Individual page records
  createdAt     DateTime                     @default(now())
  updatedAt     DateTime                     @updatedAt

  @@index([bcProjectId])
  @@index([projectId])
  @@index([fileHash])
  @@index([processingStatus])
}

// Updated BidForm model - can belong to either BidPackage or legacy Project
model BidForm {
  id                    String               @id @default(cuid())

  // New: Link to BidPackage
  bidPackageId          String?
  bidPackage            BidPackage?          @relation(fields: [bidPackageId], references: [id], onDelete: Cascade)

  // Legacy: Keep Project relation for backward compatibility
  projectId             String?
  project               Project?             @relation(fields: [projectId], references: [id], onDelete: Cascade)

  diagramId             String?
  diagram               Diagram?             @relation(fields: [diagramId], references: [id], onDelete: SetNull)
  extractionConfidence  String?
  rawExtractedText      String?              @db.Text
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  lineItems             LineItem[]
  verificationRecords   VerificationRecord[]
  status                String               @default("draft") // draft, in_review, verified, exported

  @@index([bidPackageId])
  @@index([projectId])
}

model LineItem {
  id          String   @id @default(cuid())
  bidFormId   String
  bidForm     BidForm  @relation(fields: [bidFormId], references: [id], onDelete: Cascade)
  itemNumber  String?
  description String
  quantity    Float?
  unit        String?
  unitPrice   Float?
  totalPrice  Float?
  notes       String?  @db.Text
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  verified    Boolean  @default(false)
  csiCode     String?  // CSI MasterFormat code (e.g., "03 30 00")
  csiTitle    String?  // CSI MasterFormat title (e.g., "Cast-in-Place Concrete")
}

model VerificationRecord {
  id          String   @id @default(cuid())
  bidFormId   String
  bidForm     BidForm  @relation(fields: [bidFormId], references: [id], onDelete: Cascade)
  verifiedBy  String?  // User ID or name
  comments    String?  @db.Text
  status      String   // pending, approved, needs_review
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================================
// ADVANCED EXTRACTION SYSTEM
// ============================================================================

// Extraction session - tracks a multi-pass extraction run
model ExtractionSession {
  id              String                    @id @default(cuid())
  projectId       String
  project         BuildingConnectedProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Configuration used for this extraction
  config          String                    @db.Text  // JSON ExtractionConfig

  // Status tracking
  status          String                    @default("initializing") // initializing, pass_1_extracting, pass_2_reviewing, pass_3_validating, awaiting_review, completed, failed
  currentPass     Int                       @default(0)
  progress        Int                       @default(0) // 0-100
  statusMessage   String?

  // Results summary
  metrics         String?                   @db.Text  // JSON ExtractionMetrics

  // Processing history
  passes          String?                   @db.Text  // JSON ExtractionPass[]

  // Error tracking
  error           String?                   @db.Text

  // Timestamps
  startedAt       DateTime                  @default(now())
  completedAt     DateTime?

  // Relations
  workPackages    ExtractedWorkPackageRecord[]
  observations    AIObservationRecord[]
  documentRefs    DocumentReferenceRecord[]
  predictions     PredictionRecord[]

  @@index([projectId])
  @@index([status])
}

// Work package extracted during a session
model ExtractedWorkPackageRecord {
  id                  String            @id @default(cuid())
  sessionId           String
  session             ExtractionSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Package identification
  packageId           String            // e.g., "MEC", "ELE"
  name                String
  description         String?           @db.Text
  trade               String
  scopeResponsible    String?

  // CSI Classification
  csiDivisionCode     String
  csiDivisionName     String
  csiSectionCode      String?
  csiSectionName      String?
  csiConfidence       Float
  csiReasoning        String?           @db.Text

  // Metrics
  itemCount           Int               @default(0)
  complexity          String            @default("medium") // low, medium, high

  // Extraction metadata
  extractedBy         String            // ModelIdentifier
  extractionPass      Int
  confidence          Float             @default(0.5)
  confidenceDetails   String?           @db.Text  // JSON ConfidenceScore

  // Key document references (JSON array of reference IDs)
  keyDocumentRefs     String?           @db.Text

  // Relations
  lineItems           ExtractedLineItemRecord[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([sessionId])
  @@index([csiDivisionCode])
  @@index([trade])
}

// Line item within a work package
model ExtractedLineItemRecord {
  id                  String                      @id @default(cuid())
  workPackageId       String
  workPackage         ExtractedWorkPackageRecord  @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  // Item data
  itemNumber          String?
  description         String
  action              String
  quantity            Float?
  unit                String?
  quantityNotes       String?
  specifications      String?           @db.Text
  notes               String?           @db.Text

  // Ordering
  orderIndex          Int               @default(0)

  // Document references (JSON array of reference IDs)
  referenceIds        String?           @db.Text
  primaryReferenceId  String?

  // Extraction metadata
  extractedBy         String
  extractionPass      Int
  confidence          Float             @default(0.5)
  confidenceDetails   String?           @db.Text
  flags               String?           @db.Text  // JSON array of ConfidenceFlag

  // Human review tracking
  humanReviewed       Boolean           @default(false)
  humanReviewedBy     String?
  humanReviewedAt     DateTime?
  humanCorrections    String?           @db.Text  // JSON of corrections made

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([workPackageId])
  @@index([humanReviewed])
}

// Document reference - links extracted items to source documents
model DocumentReferenceRecord {
  id                  String            @id @default(cuid())
  sessionId           String
  session             ExtractionSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Source document (links to Diagram)
  documentId          String            // Diagram ID
  documentName        String
  documentType        String            // DocumentType

  // Location within document
  pageNumber          Int
  sheetNumber         String?
  boundingBox         String?           @db.Text  // JSON BoundingBox
  textRange           String?           @db.Text  // JSON TextRange
  extractedText       String?           @db.Text

  // Reference metadata
  relationshipType    String            // DocumentRelationshipType
  displayLabel        String
  previewSnippet      String?           @db.Text
  thumbnailUrl        String?

  // Extraction info
  extractedBy         String
  confidence          Float             @default(0.5)
  reasoning           String?           @db.Text

  createdAt           DateTime          @default(now())

  @@index([sessionId])
  @@index([documentId])
  @@index([relationshipType])
}

// AI observation / insight
model AIObservationRecord {
  id                  String            @id @default(cuid())
  sessionId           String
  session             ExtractionSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Classification
  severity            String            // critical, warning, info
  category            String            // ObservationCategory

  // Content
  title               String
  insight             String            @db.Text
  suggestedActions    String?           @db.Text  // JSON array

  // What it affects (JSON arrays)
  affectedPackageIds  String?           @db.Text
  affectedItemIds     String?           @db.Text

  // Document references (JSON array of reference IDs)
  referenceIds        String?           @db.Text

  // Extraction metadata
  extractedBy         String
  confidence          Float             @default(0.5)

  // User response tracking
  acknowledged        Boolean           @default(false)
  userResponse        String?           @db.Text
  respondedAt         DateTime?
  respondedBy         String?

  createdAt           DateTime          @default(now())

  @@index([sessionId])
  @@index([severity])
  @@index([category])
  @@index([acknowledged])
}

// ============================================================================
// PHASE 2: LEARNING & OPTIMIZATION
// ============================================================================

// Prediction tracking for model performance analysis
model PredictionRecord {
  id                  String            @id @default(cuid())
  sessionId           String
  session             ExtractionSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // What was predicted
  entityType          String            // work_package, line_item, observation
  entityId            String
  fieldName           String
  predictedValue      String            @db.Text  // JSON
  predictedConfidence Float
  predictedBy         String            // ModelIdentifier

  // Final outcome (after human review)
  finalValue          String?           @db.Text  // JSON
  finalSource         String?           // human_correction, model_refinement, consensus, accepted
  correctedBy         String?           // User ID if human
  correctedAt         DateTime?

  // Analysis
  wasCorrect          Boolean?
  errorMagnitude      Float?            // For numeric comparisons
  errorCategory       String?           // Type of error

  // Context for learning
  contextData         String?           @db.Text  // JSON context (project type, size, etc.)

  createdAt           DateTime          @default(now())

  @@index([sessionId])
  @@index([entityType])
  @@index([predictedBy])
  @@index([wasCorrect])
}

// Confidence calibration data (aggregated)
model ConfidenceCalibration {
  id                  String            @id @default(cuid())

  // Dimensions for grouping
  model               String
  entityType          String
  fieldName           String

  // Calibration data
  calibrationData     String            @db.Text  // JSON bins array
  brierScore          Float
  calibrationError    Float
  sampleCount         Int

  lastUpdated         DateTime          @default(now())

  @@unique([model, entityType, fieldName])
  @@index([model])
}

// ============================================================================
// LARGE DOCUMENT SUPPORT
// ============================================================================

// Individual page within a document (for large PDF support)
model DocumentPage {
  id                      String    @id @default(cuid())
  diagramId               String
  diagram                 Diagram   @relation(fields: [diagramId], references: [id], onDelete: Cascade)

  // Page identification
  pageNumber              Int
  sheetNumber             String?   // Extracted sheet number (e.g., "M0.1", "E1.0")

  // CSI/Trade classification
  csiDivision             String?   // CSI division code (e.g., "23" for HVAC)
  trade                   String?   // Trade name (e.g., "Mechanical", "Electrical")
  pageType                String    @default("plan") // cover, index, plan, schedule, detail, section, elevation, specification, diagram, legend, general_notes
  classificationConfidence Float    @default(0)
  classificationMethod    String?   // 'pattern' or 'ai'

  // Page content
  imageUrl                String    // URL to rendered page image
  thumbnailUrl            String?   // URL to thumbnail (lower res)
  textContent             String?   @db.Text  // Extracted text layer
  textPreview             String?   // First 500 chars for quick display

  // Dimensions & metrics
  width                   Int
  height                  Int
  estimatedTokens         Int?      // Estimated token count for this page

  // Processing status
  processedAt             DateTime?
  extractionBatchId       String?   // Which batch processed this page

  createdAt               DateTime  @default(now())

  // Relations
  lineItemRefs            LineItemPageRef[]

  @@unique([diagramId, pageNumber])
  @@index([diagramId])
  @@index([csiDivision])
  @@index([trade])
  @@index([pageType])
  @@index([extractionBatchId])
}

// Links extracted line items to source pages (for multi-page reference tracking)
model LineItemPageRef {
  id                  String        @id @default(cuid())
  lineItemId          String        // References ExtractedLineItemRecord.id
  pageId              String
  page                DocumentPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Location on page
  boundingBox         String?       @db.Text  // JSON BoundingBox { x, y, width, height }
  relationshipType    String        @default("defined_at") // defined_at, modified_by, clarified_in, quantity_from, detail_at, spec_section
  confidence          Float         @default(0.5)

  createdAt           DateTime      @default(now())

  @@unique([lineItemId, pageId])
  @@index([lineItemId])
  @@index([pageId])
}

// Tracks batches of pages processed together during extraction
model ExtractionBatch {
  id                  String    @id @default(cuid())
  sessionId           String

  // Batch info
  batchNumber         Int
  trade               String?   // Trade this batch is for (if trade-grouped)
  pageNumbers         String    @db.Text  // JSON array of page numbers
  pageCount           Int

  // Processing status
  status              String    @default("pending") // pending, processing, completed, failed
  startedAt           DateTime?
  completedAt         DateTime?

  // Results
  itemsFound          Int       @default(0)
  observationsFound   Int       @default(0)
  tokensUsed          String?   @db.Text  // JSON { input: number, output: number }
  cost                Float?    // Estimated cost in USD
  error               String?   @db.Text

  createdAt           DateTime  @default(now())

  @@index([sessionId])
  @@index([status])
  @@index([trade])
}
